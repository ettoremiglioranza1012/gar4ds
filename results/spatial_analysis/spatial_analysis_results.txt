================================================================================
SPATIAL ANALYSIS - PANEL DATA REFACTORED VERSION
================================================================================
Analysis Date: 2026-02-05 17:10:55.780252

Outputs:
    Text Log: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_analysis/spatial_analysis_results.txt
    CSV Results: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_analysis
    Visualizations: /Users/ettoremiglioranza/Projects/gar4ds/assets/spatial_analysis
    Weights File: /Users/ettoremiglioranza/Projects/gar4ds/weights

[1] LOADING PANEL DATA
================================================================================
    Loading: /Users/ettoremiglioranza/Projects/gar4ds/data/panel_data_matrix.parquet
    âœ“ Shape: (21275, 20) (observations Ã— variables)
    âœ“ Index: ['week_start', 'station_id']
    âœ“ Columns: ['Vwind_550', 'Vwind_850', 'Vwind_950', 'blh', 'humidity_550', 'humidity_850', 'humidity_950', 'pm10', 'solar_radiation_downwards', 'surface_pressure', 'temperature_2m', 'temperature_550', 'temperature_850', 'temperature_950', 'total_precipitation', 'uwind_550', 'uwind_850', 'uwind_950', 'wind_u_10m', 'wind_v_10m']
    âœ“ MultiIndex confirmed: ['week_start', 'station_id']
    âœ“ Time periods: 575
    âœ“ Stations: 37

[2] LOADING STATION METADATA
================================================================================
    Loading: /Users/ettoremiglioranza/Projects/gar4ds/data/pm10_era5_land_era5_reanalysis_blh_stations_metadata.geojson
    âœ“ Loaded 37 stations
    âœ“ Columns: ['station_name', 'region', 'Longitude', 'Latitude']
    âœ“ Regions: ['Veneto', 'Lombardia', 'Trentino', 'Alto-Adige']
    âœ“ Coordinate range:
        Longitude: [8.7543, 12.5104]
        Latitude: [44.9996, 46.7974]

[3] CREATING CROSS-SECTIONAL VIEW
================================================================================
    Strategy: Time-aggregate panel data (mean over all weeks)
    Formula: XÌ„áµ¢ = (1/T) Î£â‚œ Xáµ¢â‚œ

    âœ“ Aggregation complete
    âœ“ Output shape: (37, 20) (stations Ã— variables)
    âœ“ Stations: ['402201', '402203', '402204', '402206', '402209', '402211', '402212', '402213', '502604', '502608', '502609', '502612', '502701', '502720', 'AB2', 'ARPAL_001', 'ARPAL_002', 'ARPAL_005', 'ARPAL_007', 'ARPAL_008', 'ARPAL_011', 'ARPAL_012', 'ARPAL_017', 'ARPAL_019', 'ARPAL_020', 'ARPAL_022', 'ARPAL_023', 'ARPAL_026', 'ARPAL_027', 'ARPAL_028', 'BR1', 'BX1', 'BZ4', 'BZ5', 'LA1', 'LS1', 'ME1']
    âœ“ Variables: ['Vwind_550', 'Vwind_850', 'Vwind_950', 'blh', 'humidity_550', 'humidity_850', 'humidity_950', 'pm10', 'solar_radiation_downwards', 'surface_pressure', 'temperature_2m', 'temperature_550', 'temperature_850', 'temperature_950', 'total_precipitation', 'uwind_550', 'uwind_850', 'uwind_950', 'wind_u_10m', 'wind_v_10m']

    Summary statistics (cross-sectional means):
                                    mean           std            min            max
variable                                                                            
Vwind_550                      -1.608132      0.114031      -1.907667      -1.434449
Vwind_850                       0.150139      0.226998      -0.254407       0.659945
Vwind_950                      -0.059454      0.193160      -0.280407       0.589831
blh                           349.167033     35.740398     299.788770     409.038184
humidity_550                   49.191033      1.310595      46.412603      52.534028
humidity_850                   66.773547      2.822341      61.850104      75.218054
humidity_950                   67.736532      3.470193      63.695027      75.564782
pm10                           24.565096      6.696320      10.107019      34.913517
solar_radiation_downwards  563564.539872  13106.733842  543982.406177  597975.837725
surface_pressure            95024.633469   5840.132052   82370.192082  101903.411918
temperature_2m                284.483648      3.177382     276.224672     288.104504
temperature_550               259.953051      0.242415     259.476147     260.400904
temperature_850               280.549098      0.289692     279.826024     281.166882
temperature_950               286.313503      0.220409     285.832564     286.517338
total_precipitation            24.145177      3.805680      16.029446      31.498919
uwind_550                       5.610286      0.118382       5.424895       5.879354
uwind_850                       0.226845      0.299888      -0.244244       0.738976
uwind_950                      -0.509805      0.609089      -1.737769       0.472149
wind_u_10m                     -0.186730      0.320879      -1.287731       0.451317
wind_v_10m                     -0.264367      0.229765      -0.632480       0.128578

[4] ALIGNING STATIONS WITH METADATA
================================================================================
    Data stations: 37
    Metadata stations: 37
    Valid stations (intersection): 37

    âœ“ Aligned dataset shape: (37, 20)
    âœ“ Valid stations: ['402201', '402203', '402204', '402206', '402209', '402211', '402212', '402213', '502604', '502608', '502609', '502612', '502701', '502720', 'AB2', 'ARPAL_001', 'ARPAL_002', 'ARPAL_005', 'ARPAL_007', 'ARPAL_008', 'ARPAL_011', 'ARPAL_012', 'ARPAL_017', 'ARPAL_019', 'ARPAL_020', 'ARPAL_022', 'ARPAL_023', 'ARPAL_026', 'ARPAL_027', 'ARPAL_028', 'BR1', 'BX1', 'BZ4', 'BZ5', 'LA1', 'LS1', 'ME1']

[5] BUILDING SPATIAL WEIGHTS MATRIX
================================================================================
    Method: K-Nearest Neighbors (KNN)
    K: 6 neighbors
    Justification: KNN ensures logical connectivity in Alpine terrain
                   (avoids linking valleys across mountains)

    âœ“ Weights matrix created
    âœ“ Number of observations: 37
    âœ“ Average neighbors: 6.00
    âœ“ Transformation: Row-standardized

    Connection distance statistics:
        Mean: 0.3449Â°
        Median: 0.3133Â°
        Min: 0.0133Â°
        Max: 1.0782Â°

    Approximate distance in km (1Â° â‰ˆ 111 km):
        Mean: 38.28 km
        Median: 34.77 km
        Max: 119.68 km

[6] SAVING SPATIAL WEIGHTS (.GAL FORMAT)
================================================================================
    Output: /Users/ettoremiglioranza/Projects/gar4ds/weights/spatial_weights_knn6.gal
    Purpose: Input for Spatial Durbin Model regression
    âœ“ GAL file saved successfully
    âœ“ Format: Station_ID followed by neighbor Station_IDs
    âœ“ Total connections: 222

[7] CALCULATING GLOBAL MORAN'S I
================================================================================
    Purpose: Test spatial autocorrelation (justify spatial lag term ÏWy)
    Null hypothesis: Values are randomly distributed in space
    Interpretation: I > 0 â†’ Clustering, I < 0 â†’ Dispersion, I â‰ˆ 0 â†’ Random

    --- Vwind_550 ---
        Moran's I: 0.6556
        P-value: 0.0010
        Z-score: 8.2882
        Pattern: Clustered **

    --- Vwind_850 ---
        Moran's I: 0.4241
        P-value: 0.0010
        Z-score: 5.5407
        Pattern: Clustered **

    --- Vwind_950 ---
        Moran's I: 0.3215
        P-value: 0.0010
        Z-score: 5.2222
        Pattern: Clustered **

    --- blh ---
        Moran's I: 0.4856
        P-value: 0.0010
        Z-score: 6.5685
        Pattern: Clustered **

    --- humidity_550 ---
        Moran's I: 0.4008
        P-value: 0.0010
        Z-score: 5.3134
        Pattern: Clustered **

    --- humidity_850 ---
        Moran's I: 0.2598
        P-value: 0.0040
        Z-score: 3.6338
        Pattern: Clustered **

    --- humidity_950 ---
        Moran's I: 0.3240
        P-value: 0.0020
        Z-score: 4.3929
        Pattern: Clustered **

    --- pm10 ---
        Moran's I: 0.6813
        P-value: 0.0010
        Z-score: 9.1291
        Pattern: Clustered **

    --- solar_radiation_downwards ---
        Moran's I: 0.3067
        P-value: 0.0040
        Z-score: 4.1969
        Pattern: Clustered **

    --- surface_pressure ---
        Moran's I: 0.6740
        P-value: 0.0010
        Z-score: 8.8390
        Pattern: Clustered **

    --- temperature_2m ---
        Moran's I: 0.5503
        P-value: 0.0010
        Z-score: 7.0717
        Pattern: Clustered **

    --- temperature_550 ---
        Moran's I: 0.7423
        P-value: 0.0010
        Z-score: 9.4190
        Pattern: Clustered **

    --- temperature_850 ---
        Moran's I: 0.6257
        P-value: 0.0010
        Z-score: 8.2352
        Pattern: Clustered **

    --- temperature_950 ---
        Moran's I: 0.6398
        P-value: 0.0010
        Z-score: 8.0150
        Pattern: Clustered **

    --- total_precipitation ---
        Moran's I: 0.3018
        P-value: 0.0010
        Z-score: 4.1769
        Pattern: Clustered **

    --- uwind_550 ---
        Moran's I: 0.7107
        P-value: 0.0010
        Z-score: 9.6235
        Pattern: Clustered **

    --- uwind_850 ---
        Moran's I: 0.6067
        P-value: 0.0010
        Z-score: 7.6124
        Pattern: Clustered **

    --- uwind_950 ---
        Moran's I: 0.6895
        P-value: 0.0010
        Z-score: 8.6226
        Pattern: Clustered **

    --- wind_u_10m ---
        Moran's I: 0.5073
        P-value: 0.0010
        Z-score: 7.1226
        Pattern: Clustered **

    --- wind_v_10m ---
        Moran's I: 0.6726
        P-value: 0.0010
        Z-score: 8.8501
        Pattern: Clustered **

================================================================================
GLOBAL MORAN'S I SUMMARY
================================================================================
                 Variable  Morans_I  Expected_I  Variance_I  Z_score  P_value Significant   Pattern
                Vwind_550  0.655608   -0.027778    0.006769 8.288231    0.001         Yes Clustered
                Vwind_850  0.424080   -0.027778    0.006616 5.540710    0.001         Yes Clustered
                Vwind_950  0.321550   -0.027778    0.004657 5.222155    0.001         Yes Clustered
                      blh  0.485592   -0.027778    0.006093 6.568526    0.001         Yes Clustered
             humidity_550  0.400761   -0.027778    0.006403 5.313435    0.001         Yes Clustered
             humidity_850  0.259816   -0.027778    0.006157 3.633814    0.004         Yes Clustered
             humidity_950  0.324012   -0.027778    0.006307 4.392882    0.002         Yes Clustered
                     pm10  0.681338   -0.027778    0.006091 9.129147    0.001         Yes Clustered
solar_radiation_downwards  0.306657   -0.027778    0.006227 4.196934    0.004         Yes Clustered
         surface_pressure  0.673980   -0.027778    0.006314 8.838969    0.001         Yes Clustered
           temperature_2m  0.550323   -0.027778    0.006676 7.071726    0.001         Yes Clustered
          temperature_550  0.742294   -0.027778    0.006580 9.418987    0.001         Yes Clustered
          temperature_850  0.625688   -0.027778    0.006331 8.235155    0.001         Yes Clustered
          temperature_950  0.639817   -0.027778    0.006982 8.015040    0.001         Yes Clustered
      total_precipitation  0.301814   -0.027778    0.006159 4.176853    0.001         Yes Clustered
                uwind_550  0.710676   -0.027778    0.005936 9.623458    0.001         Yes Clustered
                uwind_850  0.606739   -0.027778    0.006986 7.612387    0.001         Yes Clustered
                uwind_950  0.689518   -0.027778    0.006907 8.622591    0.001         Yes Clustered
               wind_u_10m  0.507317   -0.027778    0.005549 7.122633    0.001         Yes Clustered
               wind_v_10m  0.672601   -0.027778    0.006284 8.850072    0.001         Yes Clustered

[8] CALCULATING LOCAL MORAN'S I (LISA)
================================================================================
    Purpose: Identify spatial clusters and outliers
    Cluster types:
        High-High: High values surrounded by high values (hotspots)
        Low-Low: Low values surrounded by low values (coldspots)
        High-Low: High values surrounded by low values (spatial outliers)
        Low-High: Low values surrounded by high values (spatial outliers)

    --- Vwind_550 ---
        High-High (hotspots): 12
        Low-Low (coldspots): 7
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 18

    --- Vwind_850 ---
        High-High (hotspots): 6
        Low-Low (coldspots): 7
        High-Low (outliers): 0
        Low-High (outliers): 1
        Not significant: 23

    --- Vwind_950 ---
        High-High (hotspots): 5
        Low-Low (coldspots): 4
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 28

    --- blh ---
        High-High (hotspots): 7
        Low-Low (coldspots): 9
        High-Low (outliers): 0
        Low-High (outliers): 1
        Not significant: 20

    --- humidity_550 ---
        High-High (hotspots): 1
        Low-Low (coldspots): 5
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 31

    --- humidity_850 ---
        High-High (hotspots): 0
        Low-Low (coldspots): 5
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 32

    --- humidity_950 ---
        High-High (hotspots): 6
        Low-Low (coldspots): 5
        High-Low (outliers): 2
        Low-High (outliers): 1
        Not significant: 23

    --- pm10 ---
        High-High (hotspots): 11
        Low-Low (coldspots): 16
        High-Low (outliers): 0
        Low-High (outliers): 2
        Not significant: 8

    --- solar_radiation_downwards ---
        High-High (hotspots): 0
        Low-Low (coldspots): 8
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 29

    --- surface_pressure ---
        High-High (hotspots): 12
        Low-Low (coldspots): 16
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 9

    --- temperature_2m ---
        High-High (hotspots): 7
        Low-Low (coldspots): 8
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 22

    --- temperature_550 ---
        High-High (hotspots): 8
        Low-Low (coldspots): 8
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 21

    --- temperature_850 ---
        High-High (hotspots): 6
        Low-Low (coldspots): 8
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 23

    --- temperature_950 ---
        High-High (hotspots): 8
        Low-Low (coldspots): 6
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 23

    --- total_precipitation ---
        High-High (hotspots): 6
        Low-Low (coldspots): 4
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 27

    --- uwind_550 ---
        High-High (hotspots): 9
        Low-Low (coldspots): 12
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 16

    --- uwind_850 ---
        High-High (hotspots): 8
        Low-Low (coldspots): 12
        High-Low (outliers): 1
        Low-High (outliers): 0
        Not significant: 16

    --- uwind_950 ---
        High-High (hotspots): 16
        Low-Low (coldspots): 6
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 15

    --- wind_u_10m ---
        High-High (hotspots): 11
        Low-Low (coldspots): 5
        High-Low (outliers): 1
        Low-High (outliers): 0
        Not significant: 20

    --- wind_v_10m ---
        High-High (hotspots): 13
        Low-Low (coldspots): 12
        High-Low (outliers): 1
        Low-High (outliers): 1
        Not significant: 10

    âœ“ LISA analysis complete for all variables

[9] CREATING LISA CLUSTER MAPS
================================================================================
    Focus: PM10 (primary pollutant)
    âœ“ LISA cluster map saved: lisa_cluster_map_pm10.png

[10] CREATING MORAN'S I COMPARISON PLOT
================================================================================
    âœ“ Comparison plot saved: global_morans_i_comparison.png

[11] MULTIVARIATE CLUSTERING ANALYSIS
================================================================================
    Purpose: Detect atmospheric regimes (mountain vs plain)
    Method: K-Means clustering on standardized meteorological profiles
    Output: Cluster IDs â†’ Dummy variables for regression

    Clustering variables: ['Vwind_550', 'Vwind_850', 'Vwind_950', 'blh', 'humidity_550', 'humidity_850', 'humidity_950', 'solar_radiation_downwards', 'surface_pressure', 'temperature_2m', 'temperature_550', 'temperature_850', 'temperature_950', 'total_precipitation', 'uwind_550', 'uwind_850', 'uwind_950', 'wind_u_10m', 'wind_v_10m']
    Feature matrix shape: (37, 19) (stations Ã— variables)

    Standardizing features...
    âœ“ Features standardized (mean=0, std=1)

    Determining optimal number of clusters...
    âœ“ Optimal K: 6

    Performing K-Means clustering (k=6)...

    Cluster distribution:
        Cluster 0: 6 stations
        Cluster 1: 7 stations
        Cluster 2: 7 stations
        Cluster 3: 5 stations
        Cluster 4: 8 stations
        Cluster 5: 4 stations

    Performing PCA for 2D visualization...
    âœ“ PC1 explains 44.0% variance
    âœ“ PC2 explains 24.0% variance
    âœ“ Total explained: 68.1%

    Calculating cluster profiles...

================================================================================
CLUSTER PROFILES - ATMOSPHERIC REGIMES
================================================================================
 Cluster  N_Stations  Vwind_550_mean  Vwind_550_std  Vwind_850_mean  Vwind_850_std  Vwind_950_mean  Vwind_950_std   blh_mean   blh_std  humidity_550_mean  humidity_550_std  humidity_850_mean  humidity_850_std  humidity_950_mean  humidity_950_std  solar_radiation_downwards_mean  solar_radiation_downwards_std  surface_pressure_mean  surface_pressure_std  temperature_2m_mean  temperature_2m_std  temperature_550_mean  temperature_550_std  temperature_850_mean  temperature_850_std  temperature_950_mean  temperature_950_std  total_precipitation_mean  total_precipitation_std  uwind_550_mean  uwind_550_std  uwind_850_mean  uwind_850_std  uwind_950_mean  uwind_950_std  wind_u_10m_mean  wind_u_10m_std  wind_v_10m_mean  wind_v_10m_std  pm10_mean  pm10_std
       0           6       -1.459432       0.019643        0.181955       0.047055       -0.171349       0.066944 314.995655  9.546498          49.510819          0.440615          65.337010          1.017545          65.744792          0.243573                   561626.321009                   11247.078608          100944.313147            962.400571           287.195855            0.668815            259.918891             0.061916            280.486847             0.109104            285.919726             0.093064                 23.953128                 1.799798        5.473672       0.014662        0.649898       0.075315       -1.512036       0.177169        -0.724888        0.403858        -0.565968        0.086044  30.213842  3.903481
       1           7       -1.510247       0.047979        0.061116       0.037207       -0.068665       0.064157 328.206640 10.249248          49.829349          0.433319          69.054110          0.559896          72.455382          0.673780                   548315.921484                    3643.820553           90473.881609           2082.290039           282.631087            1.307659            259.906306             0.054700            280.416304             0.054354            286.384836             0.065270                 28.842521                 1.873072        5.465073       0.026398        0.212320       0.144559        0.027212       0.117717         0.016814        0.082146        -0.035472        0.083533  18.878981  4.265438
       2           7       -1.652992       0.044845        0.456052       0.121152        0.147270       0.307434 388.078721  8.287235          47.201541          0.555537          63.808524          1.134254          64.947102          0.709582                   579732.734166                    5523.350069          100382.159225            437.334223           287.470744            0.190895            260.304668             0.059468            280.976434             0.124304            286.440784             0.054901                 19.631854                 2.556464        5.718870       0.106573        0.115520       0.377660       -0.988684       0.203058        -0.259781        0.089544        -0.196318        0.190588  30.882083  2.532733
       3           5       -1.689336       0.033929       -0.005193       0.083409       -0.106115       0.088247 394.600738 23.190519          49.455817          0.259913          65.946522          0.998998          66.291335          1.327142                   559687.647681                    4862.763773           90539.257220           1085.960976           282.760279            0.733526            259.688426             0.064312            280.345973             0.055385            286.423142             0.039503                 22.459563                 2.536787        5.687041       0.048662       -0.091077       0.137738       -0.073489       0.116062        -0.056169        0.068546        -0.022536        0.060615  17.689117  1.019416
       4           8       -1.610759       0.015588        0.206707       0.228401       -0.037696       0.169161 325.317612 11.079626          48.843035          0.674525          66.194656          0.737023          66.076527          2.173836                   561458.995541                    4572.399139           97976.044818           1198.666850           285.902657            0.574146            260.077462             0.052089            280.688265             0.057092            286.455001             0.019533                 24.784110                 2.696517        5.663556       0.033668        0.270691       0.185480       -0.411066       0.160444        -0.131948        0.031548        -0.438724        0.112163  28.311181  2.614628
       5           4       -1.817212       0.064002       -0.196117       0.063597       -0.222453       0.023987 359.916047 42.673435          51.440926          0.750969          72.317723          2.875759          72.474166          3.211696                   573919.814234                   18516.527463           84437.157244           1470.506911           277.746091            1.019081            259.552723             0.079404            280.102596             0.278345            286.136548             0.275748                 24.940364                 4.124195        5.676820       0.023936        0.122219       0.248173        0.148927       0.269400         0.119376        0.275521        -0.285192        0.078802  16.090753  1.340888

[12] CREATING CLUSTERING VISUALIZATIONS
================================================================================
    Creating PCA scatter plot...
    âœ“ PCA scatter saved
    Creating spatial cluster map...
    âœ“ Spatial cluster map saved
    Creating cluster profile heatmap...
    âœ“ Cluster heatmap saved
    âœ“ All clustering visualizations complete

[13] CREATING CONNECTIVITY VISUALIZATION
================================================================================
    Drawing connections...
    Drawing stations...
    âœ“ Connectivity network saved: spatial_connectivity_network.png

================================================================================
SAVING RESULTS
================================================================================
    âœ“ Station profiles: station_profiles_cross_sectional.csv
    âœ“ Global Moran's I: optionA_global_morans_I_by_variable.csv
    âœ“ LISA results: optionA_lisa_results_all_variables.csv
    âœ“ Cluster assignments: optionC_multivariate_clusters.csv
    âœ“ Cluster profiles: optionC_cluster_profiles.csv

================================================================================
ANALYSIS COMPLETE
================================================================================

ðŸ“Š KEY FINDINGS:
    â€¢ Stations analyzed: 37
    â€¢ Variables analyzed: 20
    â€¢ Spatial connections: 222

    â€¢ Variables with significant spatial autocorrelation: 20
        ['Vwind_550', 'Vwind_850', 'Vwind_950', 'blh', 'humidity_550', 'humidity_850', 'humidity_950', 'pm10', 'solar_radiation_downwards', 'surface_pressure', 'temperature_2m', 'temperature_550', 'temperature_850', 'temperature_950', 'total_precipitation', 'uwind_550', 'uwind_850', 'uwind_950', 'wind_u_10m', 'wind_v_10m']

    â€¢ PM10 hotspots identified: 11
        ['502608', '502609', '502701', 'ARPAL_002', 'ARPAL_005', 'ARPAL_007', 'ARPAL_019', 'ARPAL_020', 'ARPAL_022', 'ARPAL_027', 'ARPAL_028']

    â€¢ Atmospheric regimes (clusters): 6

âœ… CRITICAL OUTPUT FOR REGRESSION:
    â†’ Spatial weights file: /Users/ettoremiglioranza/Projects/gar4ds/weights/spatial_weights_knn6.gal
    â†’ Use this .gal file in your Spatial Durbin Model

================================================================================
