================================================================================
SPATIAL ANALYSIS - PANEL DATA REFACTORED VERSION
================================================================================
Analysis Date: 2026-02-10 10:35:11.721201

Outputs:
    Text Log: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_analysis/spatial_analysis_results.txt
    CSV Results: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_analysis
    Visualizations: /Users/ettoremiglioranza/Projects/gar4ds/assets/spatial_analysis
    Weights File: /Users/ettoremiglioranza/Projects/gar4ds/weights

[1] LOADING PANEL DATA
================================================================================
    Loading: /Users/ettoremiglioranza/Projects/gar4ds/data/panel_data_matrix_filtered_for_collinearity_daily.parquet
    âœ“ Shape: (148666, 12) (observations Ã— variables)
    âœ“ Index: ['date', 'station_id']
    âœ“ Columns: ['pm10', 'temperature_2m', 'humidity_950', 'blh', 'solar_radiation_downwards', 'wind_u_10m', 'wind_v_10m', 'uwind_850', 'uwind_950', 'Vwind_850', 'Vwind_950', 'total_precipitation']
    âœ“ MultiIndex confirmed: ['date', 'station_id']
    âœ“ Time periods (days): 4018
    âœ“ Stations: 37

[2] LOADING STATION METADATA
================================================================================
    Loading: /Users/ettoremiglioranza/Projects/gar4ds/data/pm10_era5_land_era5_reanalysis_blh_stations_metadata_with_elevation.geojson
    âœ“ Loaded 37 stations
    âœ“ Columns: ['station_name', 'region', 'Longitude', 'Latitude', 'elevation', 'terrain_type', 'area_type']
    âœ“ Regions: ['Veneto', 'Lombardia', 'Trentino', 'Alto-Adige']
    âœ“ Coordinate range:
        Longitude: [8.7543, 12.5104]
        Latitude: [44.9996, 46.7974]
    âœ“ Elevation range: [-5.0, 1596.0] meters
    âœ“ Average elevation: 235.2 meters
    âœ“ Terrain distribution:
        plain: 31 stations
        mountain: 3 stations
        hills: 3 stations

[3] CREATING CROSS-SECTIONAL VIEW
================================================================================
    Strategy: Time-aggregate panel data (mean over all days)
    Formula: XÌ„áµ¢ = (1/T) Î£â‚œ Xáµ¢â‚œ

    âœ“ Aggregation complete
    âœ“ Output shape: (37, 12) (stations Ã— variables)
    âœ“ Stations: ['402201', '402203', '402204', '402206', '402209', '402211', '402212', '402213', '502604', '502608', '502609', '502612', '502701', '502720', 'AB2', 'ARPAL_001', 'ARPAL_002', 'ARPAL_005', 'ARPAL_007', 'ARPAL_008', 'ARPAL_011', 'ARPAL_012', 'ARPAL_017', 'ARPAL_019', 'ARPAL_020', 'ARPAL_022', 'ARPAL_023', 'ARPAL_026', 'ARPAL_027', 'ARPAL_028', 'BR1', 'BX1', 'BZ4', 'BZ5', 'LA1', 'LS1', 'ME1']
    âœ“ Variables: ['pm10', 'temperature_2m', 'humidity_950', 'blh', 'solar_radiation_downwards', 'wind_u_10m', 'wind_v_10m', 'uwind_850', 'uwind_950', 'Vwind_850', 'Vwind_950', 'total_precipitation']

    Summary statistics (cross-sectional means):
                                    mean           std            min            max
variable                                                                            
pm10                           24.538903      6.681662      10.118762      34.868725
temperature_2m                284.501056      3.178825     276.238808     288.123436
humidity_950                   67.748087      3.466499      63.711863      75.565357
blh                           349.699127     35.795986     300.251800     409.669081
solar_radiation_downwards  564131.193124  13140.194323  544491.847188  598569.179120
wind_u_10m                     -0.187236      0.321353      -1.290308       0.450417
wind_v_10m                     -0.263808      0.229709      -0.632726       0.128570
uwind_850                       0.223839      0.297925      -0.247001       0.731192
uwind_950                      -0.511700      0.610482      -1.741800       0.470829
Vwind_850                       0.148611      0.226246      -0.254185       0.657278
Vwind_950                      -0.059455      0.192602      -0.281551       0.587146
total_precipitation             3.455320      0.544616       2.293910       4.507685

[4] ALIGNING STATIONS WITH METADATA
================================================================================
    Data stations: 37
    Metadata stations: 37
    Valid stations (intersection): 37

    âœ“ Aligned dataset shape: (37, 12)
    âœ“ Valid stations: ['402201', '402203', '402204', '402206', '402209', '402211', '402212', '402213', '502604', '502608', '502609', '502612', '502701', '502720', 'AB2', 'ARPAL_001', 'ARPAL_002', 'ARPAL_005', 'ARPAL_007', 'ARPAL_008', 'ARPAL_011', 'ARPAL_012', 'ARPAL_017', 'ARPAL_019', 'ARPAL_020', 'ARPAL_022', 'ARPAL_023', 'ARPAL_026', 'ARPAL_027', 'ARPAL_028', 'BR1', 'BX1', 'BZ4', 'BZ5', 'LA1', 'LS1', 'ME1']

[5] BUILDING SPATIAL WEIGHTS MATRIX
================================================================================
    Method: K-Nearest Neighbors (KNN)
    K: 6 neighbors
    Justification: KNN ensures logical connectivity in Alpine terrain
                   (avoids linking valleys across mountains)

    âœ“ Weights matrix created
    âœ“ Number of observations: 37
    âœ“ Average neighbors: 6.00
    âœ“ Transformation: Row-standardized

    Connection distance statistics:
        Mean: 0.3449Â°
        Median: 0.3133Â°
        Min: 0.0133Â°
        Max: 1.0782Â°

    Approximate distance in km (1Â° â‰ˆ 111 km):
        Mean: 38.28 km
        Median: 34.77 km
        Max: 119.68 km

[6] SAVING SPATIAL WEIGHTS (.GAL FORMAT)
================================================================================
    Output: /Users/ettoremiglioranza/Projects/gar4ds/weights/spatial_weights_knn6.gal
    Purpose: Input for Spatial Durbin Model regression
    âœ“ GAL file saved successfully
    âœ“ Format: Station_ID followed by neighbor Station_IDs
    âœ“ Total connections: 222

[7] CALCULATING GLOBAL MORAN'S I
================================================================================
    Purpose: Test spatial autocorrelation (justify spatial lag term ÏWy)
    Null hypothesis: Values are randomly distributed in space
    Interpretation: I > 0 â†’ Clustering, I < 0 â†’ Dispersion, I â‰ˆ 0 â†’ Random

    --- pm10 ---
        Moran's I: 0.6819
        P-value: 0.0010
        Z-score: 8.9239
        Pattern: Clustered **

    --- temperature_2m ---
        Moran's I: 0.5504
        P-value: 0.0010
        Z-score: 7.5365
        Pattern: Clustered **

    --- humidity_950 ---
        Moran's I: 0.3228
        P-value: 0.0010
        Z-score: 4.4641
        Pattern: Clustered **

    --- blh ---
        Moran's I: 0.4858
        P-value: 0.0010
        Z-score: 6.2307
        Pattern: Clustered **

    --- solar_radiation_downwards ---
        Moran's I: 0.3073
        P-value: 0.0020
        Z-score: 4.1567
        Pattern: Clustered **

    --- wind_u_10m ---
        Moran's I: 0.5074
        P-value: 0.0010
        Z-score: 7.4229
        Pattern: Clustered **

    --- wind_v_10m ---
        Moran's I: 0.6725
        P-value: 0.0010
        Z-score: 8.7758
        Pattern: Clustered **

    --- uwind_850 ---
        Moran's I: 0.6048
        P-value: 0.0010
        Z-score: 7.9618
        Pattern: Clustered **

    --- uwind_950 ---
        Moran's I: 0.6893
        P-value: 0.0010
        Z-score: 9.2548
        Pattern: Clustered **

    --- Vwind_850 ---
        Moran's I: 0.4234
        P-value: 0.0010
        Z-score: 5.4688
        Pattern: Clustered **

    --- Vwind_950 ---
        Moran's I: 0.3210
        P-value: 0.0020
        Z-score: 4.6068
        Pattern: Clustered **

    --- total_precipitation ---
        Moran's I: 0.3018
        P-value: 0.0030
        Z-score: 4.1482
        Pattern: Clustered **

================================================================================
GLOBAL MORAN'S I SUMMARY
================================================================================
                 Variable  Morans_I  Expected_I  Variance_I  Z_score  P_value Significant   Pattern
                     pm10  0.681877   -0.027778    0.006315 8.923893    0.001         Yes Clustered
           temperature_2m  0.550439   -0.027778    0.005953 7.536466    0.001         Yes Clustered
             humidity_950  0.322788   -0.027778    0.006128 4.464074    0.001         Yes Clustered
                      blh  0.485833   -0.027778    0.006703 6.230699    0.001         Yes Clustered
solar_radiation_downwards  0.307328   -0.027778    0.006527 4.156656    0.002         Yes Clustered
               wind_u_10m  0.507432   -0.027778    0.005230 7.422946    0.001         Yes Clustered
               wind_v_10m  0.672466   -0.027778    0.006342 8.775845    0.001         Yes Clustered
                uwind_850  0.604847   -0.027778    0.006275 7.961802    0.001         Yes Clustered
                uwind_950  0.689268   -0.027778    0.006033 9.254783    0.001         Yes Clustered
                Vwind_850  0.423391   -0.027778    0.006862 5.468778    0.001         Yes Clustered
                Vwind_950  0.320965   -0.027778    0.005673 4.606820    0.002         Yes Clustered
      total_precipitation  0.301814   -0.027778    0.006354 4.148181    0.003         Yes Clustered

[8] CALCULATING LOCAL MORAN'S I (LISA)
================================================================================
    Purpose: Identify spatial clusters and outliers
    Cluster types:
        High-High: High values surrounded by high values (hotspots)
        Low-Low: Low values surrounded by low values (coldspots)
        High-Low: High values surrounded by low values (spatial outliers)
        Low-High: Low values surrounded by high values (spatial outliers)

    --- pm10 ---
        High-High (hotspots): 10
        Low-Low (coldspots): 16
        High-Low (outliers): 0
        Low-High (outliers): 2
        Not significant: 9

    --- temperature_2m ---
        High-High (hotspots): 5
        Low-Low (coldspots): 8
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 24

    --- humidity_950 ---
        High-High (hotspots): 6
        Low-Low (coldspots): 5
        High-Low (outliers): 1
        Low-High (outliers): 1
        Not significant: 24

    --- blh ---
        High-High (hotspots): 7
        Low-Low (coldspots): 9
        High-Low (outliers): 0
        Low-High (outliers): 1
        Not significant: 20

    --- solar_radiation_downwards ---
        High-High (hotspots): 3
        Low-Low (coldspots): 8
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 26

    --- wind_u_10m ---
        High-High (hotspots): 8
        Low-Low (coldspots): 5
        High-Low (outliers): 1
        Low-High (outliers): 0
        Not significant: 23

    --- wind_v_10m ---
        High-High (hotspots): 13
        Low-Low (coldspots): 12
        High-Low (outliers): 1
        Low-High (outliers): 1
        Not significant: 10

    --- uwind_850 ---
        High-High (hotspots): 8
        Low-Low (coldspots): 13
        High-Low (outliers): 1
        Low-High (outliers): 0
        Not significant: 15

    --- uwind_950 ---
        High-High (hotspots): 16
        Low-Low (coldspots): 6
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 15

    --- Vwind_850 ---
        High-High (hotspots): 6
        Low-Low (coldspots): 7
        High-Low (outliers): 0
        Low-High (outliers): 1
        Not significant: 23

    --- Vwind_950 ---
        High-High (hotspots): 5
        Low-Low (coldspots): 3
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 29

    --- total_precipitation ---
        High-High (hotspots): 6
        Low-Low (coldspots): 4
        High-Low (outliers): 0
        Low-High (outliers): 0
        Not significant: 27

    âœ“ LISA analysis complete for all variables

[9] CREATING LISA CLUSTER MAPS
================================================================================
    Focus: PM10 (primary pollutant)
    âœ“ LISA cluster map saved: lisa_cluster_map_pm10.png

[10] CREATING MORAN'S I COMPARISON PLOT
================================================================================
    âœ“ Comparison plot saved: global_morans_i_comparison.png

[11] MULTIVARIATE CLUSTERING ANALYSIS
================================================================================
    Purpose: Detect atmospheric regimes (mountain vs plain)
    Method: K-Means clustering on standardized meteorological profiles
    Output: Cluster IDs â†’ Dummy variables for regression

    Clustering variables: ['temperature_2m', 'humidity_950', 'blh', 'solar_radiation_downwards', 'wind_u_10m', 'wind_v_10m', 'uwind_850', 'uwind_950', 'Vwind_850', 'Vwind_950', 'total_precipitation']
    Feature matrix shape: (37, 11) (stations Ã— variables)

    Standardizing features...
    âœ“ Features standardized (mean=0, std=1)

    Determining optimal number of clusters...
    âœ“ Optimal K: 5

    Performing K-Means clustering (k=5)...

    Cluster distribution:
        Cluster 0: 5 stations
        Cluster 1: 6 stations
        Cluster 2: 11 stations
        Cluster 3: 8 stations
        Cluster 4: 7 stations

    Performing PCA for 2D visualization...
    âœ“ PC1 explains 41.7% variance
    âœ“ PC2 explains 25.0% variance
    âœ“ Total explained: 66.8%

    Calculating cluster profiles...

================================================================================
CLUSTER PROFILES - ATMOSPHERIC REGIMES
================================================================================
 Cluster  N_Stations  temperature_2m_mean  temperature_2m_std  humidity_950_mean  humidity_950_std   blh_mean   blh_std  solar_radiation_downwards_mean  solar_radiation_downwards_std  wind_u_10m_mean  wind_u_10m_std  wind_v_10m_mean  wind_v_10m_std  uwind_850_mean  uwind_850_std  uwind_950_mean  uwind_950_std  Vwind_850_mean  Vwind_850_std  Vwind_950_mean  Vwind_950_std  total_precipitation_mean  total_precipitation_std  pm10_mean  pm10_std
       0           5           287.394220            0.563736          65.723532          0.226651 317.286596  9.450057                   565745.516488                    8102.930827        -0.835104        0.340098        -0.599687        0.025531        0.652885       0.078865       -1.558315       0.160157        0.167871       0.043229       -0.186367       0.064608                  3.348172                 0.187945  31.380248  2.758339
       1           6           281.368835            2.512197          68.764314          4.404534 400.778492 10.076494                   560877.696132                    3993.917433        -0.085533        0.051317        -0.119684        0.136404       -0.127692       0.042426       -0.103246       0.056371       -0.100701       0.118670       -0.166468       0.079500                  3.056418                 0.061370  16.841273  1.723562
       2          11           281.845104            2.616321          71.236331          2.434144 331.137305 16.414030                   557322.656865                   16679.428226         0.061678        0.168267        -0.109868        0.169447        0.198538       0.160937        0.066185       0.209163        0.003358       0.112645       -0.103484       0.093903                  4.118507                 0.243816  18.797704  3.668700
       3           8           286.078430            0.465734          65.903925          2.090780 323.089955 12.960851                   560728.514997                    7443.870598        -0.136114        0.035759        -0.432636        0.112867        0.351857       0.152744       -0.537246       0.345037        0.256218       0.168553       -0.018958       0.149773                  3.474731                 0.222609  28.418473  2.351449
       4           7           287.490197            0.191307          64.949234          0.702827 388.647683  8.296313                   580354.720128                    5509.474533        -0.261221        0.089662        -0.196386        0.190798        0.112141       0.376783       -0.993132       0.203429        0.453827       0.120751        0.145828       0.306394                  2.809437                 0.365845  30.838288  2.527173

[12] CREATING CLUSTERING VISUALIZATIONS
================================================================================
    Creating PCA scatter plot...
    âœ“ PCA scatter saved
    Creating spatial cluster map...
    âœ“ Spatial cluster map saved
    Creating cluster profile heatmap...
    âœ“ Cluster heatmap saved
    âœ“ All clustering visualizations complete

[13] CREATING CONNECTIVITY VISUALIZATION
================================================================================
    Drawing connections...
    Drawing stations...
    âœ“ Connectivity network saved: spatial_connectivity_network.png

================================================================================
SAVING RESULTS
================================================================================
    âœ“ Station profiles: station_profiles_cross_sectional.csv
    âœ“ Global Moran's I: optionA_global_morans_I_by_variable.csv
    âœ“ LISA results: optionA_lisa_results_all_variables.csv
    âœ“ Cluster assignments: optionC_multivariate_clusters.csv
    âœ“ Cluster profiles: optionC_cluster_profiles.csv

================================================================================
ANALYSIS COMPLETE
================================================================================

ðŸ“Š KEY FINDINGS:
    â€¢ Stations analyzed: 37
    â€¢ Variables analyzed: 12
    â€¢ Spatial connections: 222

    â€¢ Variables with significant spatial autocorrelation: 12
        ['pm10', 'temperature_2m', 'humidity_950', 'blh', 'solar_radiation_downwards', 'wind_u_10m', 'wind_v_10m', 'uwind_850', 'uwind_950', 'Vwind_850', 'Vwind_950', 'total_precipitation']

    â€¢ PM10 hotspots identified: 10
        ['502608', '502609', '502701', 'ARPAL_002', 'ARPAL_005', 'ARPAL_007', 'ARPAL_019', 'ARPAL_020', 'ARPAL_022', 'ARPAL_028']

    â€¢ Atmospheric regimes (clusters): 5

âœ… CRITICAL OUTPUT FOR REGRESSION:
    â†’ Spatial weights file: /Users/ettoremiglioranza/Projects/gar4ds/weights/spatial_weights_knn6.gal
    â†’ Use this .gal file in your Spatial Durbin Model

================================================================================
