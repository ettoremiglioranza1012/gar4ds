================================================================================
SPATIAL DURBIN MODEL - PANEL DATA ANALYSIS
================================================================================

Analysis Date: 2026-02-12 18:22:40.946808

Outputs:
    Text Log: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/sdm_analysis_log_20260212_182240.txt
    CSV Results: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model
    Visualizations: /Users/ettoremiglioranza/Projects/gar4ds/assets/spatial_durbin_model

================================================================================
1. LOADING FILTERED PANEL DATA
================================================================================
    File: /Users/ettoremiglioranza/Projects/gar4ds/data/panel_data_matrix_filtered_for_collinearity_weekly.parquet
    ‚úì Shape: (21275, 12) (observations √ó variables)
    ‚úì Index: ['week_start', 'station_id']
    ‚úì Columns: ['pm10', 'temperature_2m', 'humidity_950', 'blh', 'solar_radiation_downwards', 'wind_u_10m', 'wind_v_10m', 'uwind_850', 'uwind_950', 'Vwind_850', 'Vwind_950', 'total_precipitation']
    ‚úì MultiIndex confirmed: ['week_start', 'station_id']
    ‚úì Time periods (weeks): 575
    ‚úì Stations: 37
    ‚úì Total observations: 21275

    Variable Summary:
        pm10                           | mean=24.57, std=14.89
        temperature_2m                 | mean=284.48, std=8.05
        humidity_950                   | mean=67.74, std=10.66
        blh                            | mean=349.17, std=179.91
        solar_radiation_downwards      | mean=563564.54, std=274159.42
        wind_u_10m                     | mean=-0.19, std=0.51
        wind_v_10m                     | mean=-0.26, std=0.47
        uwind_850                      | mean=0.23, std=1.94
        uwind_950                      | mean=-0.51, std=1.34
        Vwind_850                      | mean=0.15, std=1.59
        Vwind_950                      | mean=-0.06, std=0.82
        total_precipitation            | mean=24.15, std=26.59

================================================================================
2. LOADING STATION METADATA
================================================================================
    File: /Users/ettoremiglioranza/Projects/gar4ds/data/pm10_era5_land_era5_reanalysis_blh_stations_metadata.geojson
    ‚úì Loaded 37 stations
    ‚úì Regions: ['Veneto', 'Lombardia', 'Trentino', 'Alto-Adige']
    ‚úì Coordinate range:
        Longitude: [8.7543, 12.5104]
        Latitude: [44.9996, 46.7974]

================================================================================
3. LOADING SPATIAL WEIGHTS MATRIX
================================================================================
    File: /Users/ettoremiglioranza/Projects/gar4ds/weights/spatial_weights_knn6.gal
    ‚úì Number of observations: 37
    ‚úì Total connections: 222
    ‚úì Average neighbors: 6.00
    ‚úì Transformation: O

================================================================================
4. LOADING REGIME CLASSIFICATIONS
================================================================================
    File: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_analysis/optionC_multivariate_clusters.csv
    ‚úì Loaded 37 station classifications
    ‚úì Columns: ['Station', 'Cluster', 'Longitude', 'Latitude', 'PCA_1', 'PCA_2', 'temperature_2m', 'humidity_950', 'blh', 'solar_radiation_downwards', 'wind_u_10m', 'wind_v_10m', 'uwind_850', 'uwind_950', 'Vwind_850', 'Vwind_950', 'total_precipitation', 'pm10']

    Cluster Distribution:
        Cluster 0: 5 stations
        Cluster 1: 6 stations
        Cluster 2: 11 stations
        Cluster 3: 8 stations
        Cluster 4: 7 stations

================================================================================
5. PREPARING DATA FOR SDM
================================================================================
    Step 1: Log-transforming PM10
        ‚úì log_pm10 created (mean=3.100, std=0.523)

    Step 2: Meteorological variables identified (11):
        - temperature_2m
        - humidity_950
        - blh
        - solar_radiation_downwards
        - wind_u_10m
        - wind_v_10m
        - uwind_850
        - uwind_950
        - Vwind_850
        - Vwind_950
        - total_precipitation

    Step 3: Checking station alignment
        Panel stations: 37
        Metadata stations: 37
        ‚úì Common stations: 37

================================================================================
6. STANDARDIZING VARIABLES
================================================================================
    Purpose: Eliminate unit-of-measurement bias
    Method: StandardScaler (mean=0, std=1)

    ‚úì Standardized 11 variables

    Post-standardization check:
        temperature_2m                 | mean=-0.000000, std=1.000024
        humidity_950                   | mean=-0.000000, std=1.000024
        blh                            | mean=0.000000, std=1.000024
        ...

================================================================================
7. CREATING SPATIALLY LAGGED FEATURES (WX MATRIX)
================================================================================
    Purpose: Manual Spatial Durbin Model construction
    Method: Compute W @ X for each of the weeks

    Dimensions:
        Weeks: 575
        Stations: 37
        Variables: 11
        Total WX entries: 234,025

    Computing spatial lags...
        Progress: 57/575 weeks (9.9%)
        Progress: 114/575 weeks (19.8%)
        Progress: 171/575 weeks (29.7%)
        Progress: 228/575 weeks (39.7%)
        Progress: 285/575 weeks (49.6%)
        Progress: 342/575 weeks (59.5%)
        Progress: 399/575 weeks (69.4%)
        Progress: 456/575 weeks (79.3%)
        Progress: 513/575 weeks (89.2%)
        Progress: 570/575 weeks (99.1%)

    ‚úì Created 11 spatially lagged features
    ‚úì Feature set:
        Direct features (X): 11
        Lagged features (WX): 11
        Total features: 22

================================================================================
8. FITTING PANEL SPATIAL DURBIN MODEL
================================================================================
    Estimator: Panel Fixed Effects Spatial Lag (spreg.Panel_FE_Lag)
    Specification: log(PM10) = œÅWy + XŒ≤ + WXŒ∏ + Œµ

    Preparing arrays...
    ‚úì Filtered dataset: 21275 observations
    ‚úì y (log_pm10): shape (21275, 1)
    ‚úì X (met + lagged): shape (21275, 22)

    Fitting model...
    (This may take several minutes for 21k+ observations)

    ‚úì Model estimation complete!
    ‚úì Spatial lag coefficient (œÅ): 0.137761
    ‚úì œÅ p-value: 0.000000

================================================================================
9. SAVING MODEL SUMMARY
================================================================================
    ‚úì Saved to: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/model_summary.txt

================================================================================
10. EXTRACTING COEFFICIENTS
================================================================================
    ‚úì Extracted 24 coefficients

    Spatial Lag Coefficient (œÅ):
        œÅ = 0.137761

    Significant Direct Effects (Œ≤):
        temperature_2m                : Œ≤ = -0.1584 ***
        humidity_950                  : Œ≤ =  0.0990 ***
        blh                           : Œ≤ =  0.0423 ***
        solar_radiation_downwards     : Œ≤ = -0.2388 ***
        wind_u_10m                    : Œ≤ =  0.0136 ***
        wind_v_10m                    : Œ≤ =  0.0129 ***
        uwind_850                     : Œ≤ =  0.0233 ***
        Vwind_850                     : Œ≤ = -0.0546 ***
        total_precipitation           : Œ≤ = -0.0332 ***
        W_log_pm10                    : Œ≤ =  0.1378 ***

    Significant Indirect Effects (Œ∏):
        lag_temperature_2m            : Œ∏ =  0.0252 ***
        lag_humidity_950              : Œ∏ = -0.0217 ***
        lag_blh                       : Œ∏ = -0.0159 ***
        lag_solar_radiation_downwards : Œ∏ =  0.0382 ***
        lag_wind_u_10m                : Œ∏ = -0.0046 ***
        lag_uwind_850                 : Œ∏ = -0.0032 ***
        lag_Vwind_850                 : Œ∏ =  0.0127 ***
        lag_total_precipitation       : Œ∏ =  0.0016 **

================================================================================
11. DECOMPOSING SPILLOVER EFFECTS
================================================================================
    Components:
        1. Direct Local Effect: X¬∑Œ≤
        2. Indirect Neighbor Effect: WX¬∑Œ∏
        3. Endogenous Spillover: œÅ¬∑Wy

    ‚úì Computed direct effects (mean=-0.0000)
    ‚úì Computed indirect effects (mean=0.0196)
    ‚úì Endogenous spillover computed (mean=-0.0196)

================================================================================
13. REGIME-STRATIFIED ANALYSIS - ALL CLUSTERS
================================================================================
    Fitting separate SDM models for each atmospheric cluster
    Testing hypothesis: Global model averages over distinct physical regimes


    ============================================================
    CLUSTER 0
    ============================================================
    Stations: 5
    Observations: 2875
    Creating subset spatial weights matrix...
    ‚úì Subset weights created: 5 stations, 5 connections
    ‚úì Row-standardized (transform=R)
    Fitting model...
    ‚úì Model fit successful
    ‚úì œÅ (Cluster 0) = 0.808520

================================================================================
10. EXTRACTING COEFFICIENTS
================================================================================
    ‚úì Extracted 24 coefficients

    Spatial Lag Coefficient (œÅ):
        œÅ = 0.808520

    Significant Direct Effects (Œ≤):
        humidity_950                  : Œ≤ =  0.0559 ***
        solar_radiation_downwards     : Œ≤ = -0.3544 ***
        wind_v_10m                    : Œ≤ =  0.0162 ***
        uwind_850                     : Œ≤ =  0.0388 **
        Vwind_850                     : Œ≤ = -0.1072 ***
        Vwind_950                     : Œ≤ =  0.0286 ***
        W_log_pm10                    : Œ≤ =  0.8085 ***

    Significant Indirect Effects (Œ∏):
        lag_humidity_950              : Œ∏ = -0.0140 ***
        lag_blh                       : Œ∏ = -0.0104 ***
        lag_solar_radiation_downwards : Œ∏ =  0.0568 ***
        lag_wind_u_10m                : Œ∏ = -0.0066 ***
        lag_uwind_850                 : Œ∏ = -0.0092 ***
        lag_uwind_950                 : Œ∏ =  0.0075 ***
        lag_Vwind_850                 : Œ∏ =  0.0221 ***
        lag_Vwind_950                 : Œ∏ = -0.0079 ***

================================================================================
9. SAVING MODEL SUMMARY
================================================================================
    ‚úì Saved to: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/cluster_0_model_summary.txt
    ‚úì Saved model summary: cluster_0_model_summary.txt
    ‚úì Saved coefficients: cluster_0_coefficients.csv

    ============================================================
    CLUSTER 1
    ============================================================
    Stations: 6
    Observations: 3450
    Creating subset spatial weights matrix...
    ‚úì Subset weights created: 6 stations, 6 connections
    ‚úì Row-standardized (transform=R)
    Fitting model...
    ‚úì Model fit successful
    ‚úì œÅ (Cluster 1) = 0.735998

================================================================================
10. EXTRACTING COEFFICIENTS
================================================================================
    ‚úì Extracted 24 coefficients

    Spatial Lag Coefficient (œÅ):
        œÅ = 0.735998

    Significant Direct Effects (Œ≤):
        temperature_2m                : Œ≤ = -0.1491 ***
        blh                           : Œ≤ =  0.0806 ***
        solar_radiation_downwards     : Œ≤ =  0.1465 **
        wind_u_10m                    : Œ≤ = -0.1093 ***
        wind_v_10m                    : Œ≤ = -0.0953 ***
        uwind_850                     : Œ≤ =  0.4778 ***
        uwind_950                     : Œ≤ =  0.1929 **
        Vwind_950                     : Œ≤ =  0.3453 ***
        W_log_pm10                    : Œ≤ =  0.7360 ***

    Significant Indirect Effects (Œ∏):
        lag_temperature_2m            : Œ∏ =  0.0191 **
        lag_humidity_950              : Œ∏ = -0.0139 ***
        lag_blh                       : Œ∏ = -0.0239 ***
        lag_solar_radiation_downwards : Œ∏ = -0.0279 ***
        lag_wind_u_10m                : Œ∏ =  0.0281 ***
        lag_uwind_850                 : Œ∏ = -0.0383 ***
        lag_uwind_950                 : Œ∏ = -0.0806 ***
        lag_Vwind_850                 : Œ∏ =  0.0105 ***
        lag_Vwind_950                 : Œ∏ = -0.0378 ***

================================================================================
9. SAVING MODEL SUMMARY
================================================================================
    ‚úì Saved to: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/cluster_1_model_summary.txt
    ‚úì Saved model summary: cluster_1_model_summary.txt
    ‚úì Saved coefficients: cluster_1_coefficients.csv

    ============================================================
    CLUSTER 2
    ============================================================
    Stations: 11
    Observations: 6325
    Creating subset spatial weights matrix...
('WARNING: ', 'ARPAL_026', ' is an island (no neighbors)')
    ‚úì Subset weights created: 11 stations, 10 connections
    ‚úì Row-standardized (transform=R)
    Fitting model...
    ‚úì Model fit successful
    ‚úì œÅ (Cluster 2) = 0.622771

================================================================================
10. EXTRACTING COEFFICIENTS
================================================================================
    ‚úì Extracted 24 coefficients

    Spatial Lag Coefficient (œÅ):
        œÅ = 0.622771

    Significant Direct Effects (Œ≤):
        temperature_2m                : Œ≤ =  0.2989 ***
        humidity_950                  : Œ≤ =  0.2687 ***
        blh                           : Œ≤ =  0.0757 ***
        wind_u_10m                    : Œ≤ =  0.0866 ***
        wind_v_10m                    : Œ≤ = -0.1190 ***
        uwind_850                     : Œ≤ =  0.0698 ***
        uwind_950                     : Œ≤ = -0.3768 ***
        Vwind_850                     : Œ≤ = -0.1244 ***
        Vwind_950                     : Œ≤ =  0.3673 ***
        total_precipitation           : Œ≤ = -0.1037 ***
        W_log_pm10                    : Œ≤ =  0.6228 ***

    Significant Indirect Effects (Œ∏):
        lag_temperature_2m            : Œ∏ = -0.0599 ***
        lag_humidity_950              : Œ∏ = -0.0567 ***
        lag_blh                       : Œ∏ = -0.0339 ***
        lag_wind_u_10m                : Œ∏ = -0.0088 **
        lag_uwind_850                 : Œ∏ = -0.0123 ***
        lag_uwind_950                 : Œ∏ =  0.0477 ***
        lag_Vwind_850                 : Œ∏ =  0.0372 ***
        lag_Vwind_950                 : Œ∏ = -0.0388 ***
        lag_total_precipitation       : Œ∏ =  0.0111 ***

================================================================================
9. SAVING MODEL SUMMARY
================================================================================
    ‚úì Saved to: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/cluster_2_model_summary.txt
    ‚úì Saved model summary: cluster_2_model_summary.txt
    ‚úì Saved coefficients: cluster_2_coefficients.csv

    ============================================================
    CLUSTER 3
    ============================================================
    Stations: 8
    Observations: 4600
    Creating subset spatial weights matrix...
('WARNING: ', '502604', ' is an island (no neighbors)')
    ‚úì Subset weights created: 8 stations, 7 connections
    ‚úì Row-standardized (transform=R)
    Fitting model...
    ‚úì Model fit successful
    ‚úì œÅ (Cluster 3) = 0.714179

================================================================================
10. EXTRACTING COEFFICIENTS
================================================================================
    ‚úì Extracted 24 coefficients

    Spatial Lag Coefficient (œÅ):
        œÅ = 0.714179

    Significant Direct Effects (Œ≤):
        temperature_2m                : Œ≤ =  0.5477 ***
        humidity_950                  : Œ≤ =  0.0536 ***
        blh                           : Œ≤ = -0.0982 ***
        solar_radiation_downwards     : Œ≤ =  0.7295 ***
        uwind_850                     : Œ≤ =  0.0395 ***
        uwind_950                     : Œ≤ = -0.0385 ***
        W_log_pm10                    : Œ≤ =  0.7142 ***

    Significant Indirect Effects (Œ∏):
        lag_temperature_2m            : Œ∏ = -0.0974 ***
        lag_humidity_950              : Œ∏ = -0.0131 ***
        lag_solar_radiation_downwards : Œ∏ = -0.1284 ***
        lag_wind_u_10m                : Œ∏ = -0.0112 ***
        lag_wind_v_10m                : Œ∏ =  0.0064 ***
        lag_uwind_850                 : Œ∏ = -0.0060 **
        lag_uwind_950                 : Œ∏ =  0.0144 ***
        lag_Vwind_850                 : Œ∏ =  0.0062 **
        lag_Vwind_950                 : Œ∏ =  0.0069 ***
        lag_total_precipitation       : Œ∏ = -0.0138 ***

================================================================================
9. SAVING MODEL SUMMARY
================================================================================
    ‚úì Saved to: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/cluster_3_model_summary.txt
    ‚úì Saved model summary: cluster_3_model_summary.txt
    ‚úì Saved coefficients: cluster_3_coefficients.csv

    ============================================================
    CLUSTER 4
    ============================================================
    Stations: 7
    Observations: 4025
    Creating subset spatial weights matrix...
    ‚úì Subset weights created: 7 stations, 7 connections
    ‚úì Row-standardized (transform=R)
    Fitting model...
    ‚úì Model fit successful
    ‚úì œÅ (Cluster 4) = 0.697697

================================================================================
10. EXTRACTING COEFFICIENTS
================================================================================
    ‚úì Extracted 24 coefficients

    Spatial Lag Coefficient (œÅ):
        œÅ = 0.697697

    Significant Direct Effects (Œ≤):
        solar_radiation_downwards     : Œ≤ = -0.1605 ***
        uwind_950                     : Œ≤ =  0.0187 **
        Vwind_850                     : Œ≤ =  0.0215 **
        W_log_pm10                    : Œ≤ =  0.6977 ***

    Significant Indirect Effects (Œ∏):
        lag_humidity_950              : Œ∏ = -0.0053 **
        lag_blh                       : Œ∏ = -0.0147 ***
        lag_solar_radiation_downwards : Œ∏ =  0.0235 ***
        lag_wind_u_10m                : Œ∏ = -0.0051 **
        lag_total_precipitation       : Œ∏ = -0.0088 ***

================================================================================
9. SAVING MODEL SUMMARY
================================================================================
    ‚úì Saved to: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/cluster_4_model_summary.txt
    ‚úì Saved model summary: cluster_4_model_summary.txt
    ‚úì Saved coefficients: cluster_4_coefficients.csv

    ============================================================
    REGIME COMPARISON SUMMARY
    ============================================================

 cluster_id      rho  n_stations  n_obs
          0 0.808520           5   2875
          1 0.735998           6   3450
          2 0.622771          11   6325
          3 0.714179           8   4600
          4 0.697697           7   4025

    INTERPRETATION NOTES:
    - High œÅ suggests synchronous spatial correlation
    - Low œÅ may indicate directional transport (not simultaneous)
    - Compare coefficient signs across clusters for physical coherence
    - Check if global model sign conflicts resolve in cluster-specific models

================================================================================
14. RESIDUAL DIAGNOSTICS
================================================================================
    Residual Statistics:
        Mean: -0.000000
        Std: 0.172193
        Min: -1.493664
        Max: 1.066892

    Testing for residual spatial autocorrelation...
    (Should be non-significant if model captures spatial structure)

    Moran's I on residuals: -0.108991
    Expected I: -0.027778
    P-value: 0.124000
    ‚úì No significant spatial autocorrelation in residuals (Good!)

================================================================================
15. GENERATING VISUALIZATIONS
================================================================================
    Creating coefficient forest plot...
    ‚úì Saved: coefficient_forest_plot.png
    Creating residual Q-Q plot...
    ‚úì Saved: residual_qq_plot.png

    ‚úì All visualizations complete!

================================================================================
16. SAVING RESULTS
================================================================================
    ‚úì spillover_decomposition_observations.csv (21275 obs)
    ‚úì coefficients_table.csv (24 rows)
    ‚úì regime_comparison.csv (5 rows)
    ‚úì all_clusters_coefficients_combined.csv (120 rows)
        Contains coefficients for 5 cluster-specific models

    ‚úì All results saved!

================================================================================
ANALYSIS COMPLETE
================================================================================

üìä KEY FINDINGS:
    ‚Ä¢ Observations analyzed: 21,275
    ‚Ä¢ Stations: 37
    ‚Ä¢ Time periods: 575
    ‚Ä¢ Spatial lag coefficient (œÅ): 0.137761
    ‚Ä¢ Residual Moran's I: -0.108991 (p=0.1240)

‚úÖ ALL OUTPUTS GENERATED:
    ‚Üí Text log: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model/sdm_analysis_log_20260212_182240.txt
    ‚Üí CSV results: /Users/ettoremiglioranza/Projects/gar4ds/results/spatial_durbin_model
    ‚Üí Visualizations: /Users/ettoremiglioranza/Projects/gar4ds/assets/spatial_durbin_model

================================================================================
